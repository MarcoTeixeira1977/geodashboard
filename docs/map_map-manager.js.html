<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>map/map-manager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AggregateWidget.html">AggregateWidget</a><ul class='methods'><li data-type='method'><a href="AggregateWidget.html#format">format</a></li><li data-type='method'><a href="AggregateWidget.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="AggregateWidget.html#refresh">refresh</a></li></ul></li><li><a href="BaseLayer.html">BaseLayer</a><ul class='methods'><li data-type='method'><a href="BaseLayer.html#fitMap">fitMap</a></li><li data-type='method'><a href="BaseLayer.html#getVisible">getVisible</a></li></ul></li><li><a href="BingLayer.html">BingLayer</a></li><li><a href="CategoryWidget.html">CategoryWidget</a><ul class='methods'><li data-type='method'><a href="CategoryWidget.html#format">format</a></li><li data-type='method'><a href="CategoryWidget.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="CategoryWidget.html#refresh">refresh</a></li></ul></li><li><a href="ChartWidget.html">ChartWidget</a><ul class='methods'><li data-type='method'><a href="ChartWidget.html#format">format</a></li><li data-type='method'><a href="ChartWidget.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="ChartWidget.html#refresh">refresh</a></li><li data-type='method'><a href="ChartWidget.html#render">render</a></li></ul></li><li><a href="CountWidget.html">CountWidget</a><ul class='methods'><li data-type='method'><a href="CountWidget.html#format">format</a></li><li data-type='method'><a href="CountWidget.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="CountWidget.html#refresh">refresh</a></li></ul></li><li><a href="Dashboard.html">Dashboard</a><ul class='methods'><li data-type='method'><a href="Dashboard.html#.uid">uid</a></li><li data-type='method'><a href="Dashboard.html#addBaseLayer">addBaseLayer</a></li><li data-type='method'><a href="Dashboard.html#addFilter">addFilter</a></li><li data-type='method'><a href="Dashboard.html#addOverlayLayer">addOverlayLayer</a></li><li data-type='method'><a href="Dashboard.html#addWidget">addWidget</a></li><li data-type='method'><a href="Dashboard.html#centerMapToFeature">centerMapToFeature</a></li><li data-type='method'><a href="Dashboard.html#fitMapToLayer">fitMapToLayer</a></li><li data-type='method'><a href="Dashboard.html#refresh">refresh</a></li><li data-type='method'><a href="Dashboard.html#render">render</a></li><li data-type='method'><a href="Dashboard.html#resetFilters">resetFilters</a></li><li data-type='method'><a href="Dashboard.html#showFeaturePopup">showFeaturePopup</a></li></ul></li><li><a href="Filter.html">Filter</a><ul class='methods'><li data-type='method'><a href="Filter.html#.ogcLogicalOperator">ogcLogicalOperator</a></li><li data-type='method'><a href="Filter.html#.ogcOperator">ogcOperator</a></li><li data-type='method'><a href="Filter.html#execute">execute</a></li><li data-type='method'><a href="Filter.html#toString">toString</a></li></ul></li><li><a href="Layer.html">Layer</a><ul class='methods'><li data-type='method'><a href="Layer.html#fitMap">fitMap</a></li><li data-type='method'><a href="Layer.html#getVisible">getVisible</a></li></ul></li><li><a href="LayerSwitcher.html">LayerSwitcher</a><ul class='methods'><li data-type='method'><a href="LayerSwitcher.html#renderPanel">renderPanel</a></li><li data-type='method'><a href="LayerSwitcher.html#setMap">setMap</a></li><li data-type='method'><a href="LayerSwitcher.html#setVisible">setVisible</a></li></ul></li><li><a href="MapManager.html">MapManager</a><ul class='methods'><li data-type='method'><a href="MapManager.html#addBaseLayer">addBaseLayer</a></li><li data-type='method'><a href="MapManager.html#addOverlayLayer">addOverlayLayer</a></li><li data-type='method'><a href="MapManager.html#centerToFeature">centerToFeature</a></li><li data-type='method'><a href="MapManager.html#fit">fit</a></li><li data-type='method'><a href="MapManager.html#fitToLayer">fitToLayer</a></li><li data-type='method'><a href="MapManager.html#getLayerById">getLayerById</a></li><li data-type='method'><a href="MapManager.html#refresh">refresh</a></li><li data-type='method'><a href="MapManager.html#render">render</a></li><li data-type='method'><a href="MapManager.html#showFeaturePopup">showFeaturePopup</a></li></ul></li><li><a href="MVTLayer.html">MVTLayer</a><ul class='methods'><li data-type='method'><a href="MVTLayer.html#refresh">refresh</a></li></ul></li><li><a href="OSMLayer.html">OSMLayer</a></li><li><a href="OverlayLayer.html">OverlayLayer</a><ul class='methods'><li data-type='method'><a href="OverlayLayer.html#fitMap">fitMap</a></li><li data-type='method'><a href="OverlayLayer.html#getVisible">getVisible</a></li></ul></li><li><a href="VectorLayer.html">VectorLayer</a><ul class='methods'><li data-type='method'><a href="VectorLayer.html#fitMap">fitMap</a></li><li data-type='method'><a href="VectorLayer.html#getVisible">getVisible</a></li><li data-type='method'><a href="VectorLayer.html#refresh">refresh</a></li></ul></li><li><a href="WFSLayer.html">WFSLayer</a><ul class='methods'><li data-type='method'><a href="WFSLayer.html#refresh">refresh</a></li></ul></li><li><a href="Widget.html">Widget</a><ul class='methods'><li data-type='method'><a href="Widget.html#format">format</a></li><li data-type='method'><a href="Widget.html#refresh">refresh</a></li><li data-type='method'><a href="Widget.html#render">render</a></li></ul></li><li><a href="WidgetManager.html">WidgetManager</a><ul class='methods'><li data-type='method'><a href="WidgetManager.html#addWidget">addWidget</a></li><li data-type='method'><a href="WidgetManager.html#refresh">refresh</a></li><li data-type='method'><a href="WidgetManager.html#render">render</a></li></ul></li><li><a href="WMSLayer.html">WMSLayer</a><ul class='methods'><li data-type='method'><a href="WMSLayer.html#refresh">refresh</a></li></ul></li><li><a href="WPSWidget.html">WPSWidget</a><ul class='methods'><li data-type='method'><a href="WPSWidget.html#format">format</a></li><li data-type='method'><a href="WPSWidget.html#refresh">refresh</a></li><li data-type='method'><a href="WPSWidget.html#render">render</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#center">center</a></li><li><a href="global.html#zoom">zoom</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">map/map-manager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import EventEmitter from 'events';

import Map from 'ol/map';
import View from 'ol/view';
import Overlay from 'ol/overlay';
import proj from 'ol/proj';
import extent from 'ol/extent';

import LayerSwitcher from './layer-switcher';

import popupTemplate from '../../templates/map/feature-popup.hbs';

/**
 * This class takes care of everything related with the Map.
 */
class MapManager extends EventEmitter {
  /**
   * @param {Object} [config] - Configuration object
   * @param {Number[]} [config.center] - The initial center for the map
   * @param {Number} [config.zoom] - The initial zoom level
   * @param {Object} [config.mapParams] - Extra params for OpenLayers Map constructor
   * @param {Object} [config.viewParams] - Extra params for OpenLayers View constructor
   */
  constructor(config = {}) {
    super();

    this.defaultCenter = config.center || [0, 0];
    this.defaultZoom = config.zoom || 1;
    this.baseLayers = [];
    this.overlayLayers = [];
    this.mapParams = config.mapParams;
    this.viewParams = config.viewParams;

    this.createMap();
    this.createOverlay();
    this.addLayerSwitcher();
  }

  /**
   * Dashboard filter string wrapper
   * @member {String}
   * @readonly
   */
  get filterString() {
    return this.dashboard.filterString;
  }

  /**
   * Dashboard filters array wrapper
   * @member {String}
   * @readonly
   */
  get filters() {
    return this.dashboard.filters;
  }

  /**
   * Creates the [OpenLayers Map](https://openlayers.org/en/latest/apidoc/ol.Map.html) and sets its initial status.
   * @private
   */
  createMap() {
    this.view = new View(Object.assign({
      center: proj.fromLonLat(this.defaultCenter),
      zoom: this.defaultZoom,
    }, this.viewParams));

    this.map = new Map(Object.assign({
      view: this.view,
      loadTilesWhileInteracting: true,
      layers: this.layers,
    }, this.mapParams));

    this.viewProjection = this.view.getProjection();
    this.viewResolution = this.view.getResolution();

    this.map.on('moveend', (event) => {
      event.extent = this.map.getView().calculateExtent(this.map.getSize());
      this.emit('mapchange', event);
    });
  }

  /**
   * Creates the [OpenLayers Overlay](https://openlayers.org/en/latest/apidoc/ol.Overlay.html) to show popups.
   * @private
   */
  createOverlay() {
    this.overlay = new Overlay({
      autoPan: true,
      autoPanAnimation: {
        duration: 250,
      },
    });
    this.map.addOverlay(this.overlay);
    this.map.on('singleclick', (event) => {
      const pixel = this.map.getEventPixel(event.originalEvent);
      const result = this.map.forEachFeatureAtPixel(pixel, (feature, layer) => ({
        feature,
        layer,
      }));
      if (result) {
        this.showFeaturePopup(result.layer, result.feature);
      } else {
        this.overlay.setElement(null);
      }
    });
  }

  /**
   * Adds the LayerSwitcher control to the map
   * @private
   */
  addLayerSwitcher() {
    this.layerSwitcher = new LayerSwitcher();
    this.layerSwitcher.manager = this;
    this.layerSwitcher.on('layerChanged', () => {
      this.overlay.setElement(null);
    });
    this.map.addControl(this.layerSwitcher);
  }

  /**
   * Renders the map and all its components into the specefied container.
   * @param {HTMLElement} container - The element where the map will be rendered
   */
  render(container) {
    this.map.setTarget(container);
    setTimeout(() => this.map.updateSize(), 100);
  }

  /**
   * Adds a BaseLayer to the map.
   * @param {BaseLayer} layer - The layer to add
   */
  addBaseLayer(layer) {
    layer.manager = this;
    this.baseLayers.push(layer);
    this.map.addLayer(layer.layer);
  }

  /**
   * Adds an OverlayLayer to the map.
   * @param {OverlayLayer} layer - The layer to add
   */
  addOverlayLayer(layer) {
    layer.manager = this;
    this.overlayLayers.push(layer);
    this.map.addLayer(layer.layer);
    layer.on('loaded', () => this.emit('loaded'));
    layer.refresh();
  }

  /**
   * Refreshes all OverLayer layers
   */
  refresh() {
    this.overlayLayers.forEach(layer => layer.refresh());
  }

  /**
   * Map center coordinates
   * @member {Number[]} center
   */
  get center() {
    return this.view.getCenter();
  }

  set center(value) {
    this.overlay.setElement(null);
    this.view.animate({
      center: value,
      duration: 2000,
    });
  }

  /**
   * Map zoom level
   * @member {Number} zoom
   */
  get zoom() {
    return this.view.getZoom();
  }

  set zoom(value) {
    this.overlay.setElement(null);
    this.view.animate({
      zoom: value,
      duration: 1000,
    });
  }

  /**
   * Centers map to definied feature
   * @param {Object} feature - Feature to center
   */
  centerToFeature(feature) {
    this.center = extent.getCenter(feature.getGeometry().getExtent());
  }

  /**
   * Fits map to definied extent
   * @param {Number[]} toExtent - Array of numbers representing an extent: [minx, miny, maxx, maxy]
   */
  fit(toExtent) {
    if (toExtent &amp;&amp; toExtent[0] &amp;&amp; Number.isFinite(toExtent[0])) {
      this.view.fit(toExtent, {
        size: this.map.getSize(),
        duration: 1000,
      });
    }
  }

  /**
   * Fits map to defined layer
   * @param {Layer} layer - Layer to fit in map
   */
  fitToLayer(layer) {
    if (layer) {
      this.fit(layer.source.getExtent());
    }
  }

  /**
   * Displays feature popup with information
   * @param {Object} layer - Layer to show
   * @param {Object} feature - Feature to show
   */
  showFeaturePopup(layer, feature) {
    const items = [];
    layer.popup.forEach((item) => {
      const properties = Array.isArray(item.property) ? item.property : [item.property];
      const values = properties.map(property => feature.get(property));
      let value;
      if (item.format) {
        value = item.format(...values);
      } else if (values.length > 1) {
        value = values.join(' ');
      } else {
        value = values[0];
      }
      items.push({
        title: item.title,
        value,
      });
    });
    const element = document.createElement('div');
    element.innerHTML = popupTemplate({
      properties: items,
    });
    const position = extent.getCenter(feature.getGeometry().getExtent());
    this.overlay.setElement(element);
    this.view.animate({
      center: position,
      duration: 1000,
    });
    this.overlay.setPosition(position);
  }

  /**
   * Searches and returns a specifc layer
   * @param {String} id - The layer ID to find
   * @returns {Layer}
   */
  getLayerById(id) {
    let layer = this.baseLayers.find(l => l.id === id);
    if (!layer) {
      layer = this.overlayLayers.find(l => l.id === id);
    }
    return layer;
  }
}

export default MapManager;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Aug 17 2018 12:15:56 GMT-0300 (Argentina Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
