<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>map/map-manager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AggregateWidget.html">AggregateWidget</a><ul class='methods'><li data-type='method'><a href="AggregateWidget.html#format">format</a></li><li data-type='method'><a href="AggregateWidget.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="AggregateWidget.html#refresh">refresh</a></li></ul></li><li><a href="BaseLayer.html">BaseLayer</a></li><li><a href="BingLayer.html">BingLayer</a></li><li><a href="CategoryWidget.html">CategoryWidget</a><ul class='methods'><li data-type='method'><a href="CategoryWidget.html#format">format</a></li><li data-type='method'><a href="CategoryWidget.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="CategoryWidget.html#refresh">refresh</a></li></ul></li><li><a href="ChartWidget.html">ChartWidget</a><ul class='methods'><li data-type='method'><a href="ChartWidget.html#format">format</a></li><li data-type='method'><a href="ChartWidget.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="ChartWidget.html#refresh">refresh</a></li><li data-type='method'><a href="ChartWidget.html#render">render</a></li></ul></li><li><a href="CountWidget.html">CountWidget</a><ul class='methods'><li data-type='method'><a href="CountWidget.html#format">format</a></li><li data-type='method'><a href="CountWidget.html#parseResponse">parseResponse</a></li><li data-type='method'><a href="CountWidget.html#refresh">refresh</a></li></ul></li><li><a href="Dashboard.html">Dashboard</a><ul class='methods'><li data-type='method'><a href="Dashboard.html#.uid">uid</a></li><li data-type='method'><a href="Dashboard.html#addBaseLayer">addBaseLayer</a></li><li data-type='method'><a href="Dashboard.html#addOverlayLayer">addOverlayLayer</a></li><li data-type='method'><a href="Dashboard.html#addWidget">addWidget</a></li><li data-type='method'><a href="Dashboard.html#refresh">refresh</a></li><li data-type='method'><a href="Dashboard.html#render">render</a></li></ul></li><li><a href="Filter.html">Filter</a><ul class='methods'><li data-type='method'><a href="Filter.html#toString">toString</a></li></ul></li><li><a href="Layer.html">Layer</a></li><li><a href="LayerSwitcher.html">LayerSwitcher</a><ul class='methods'><li data-type='method'><a href="LayerSwitcher.html#renderPanel">renderPanel</a></li><li data-type='method'><a href="LayerSwitcher.html#setMap">setMap</a></li><li data-type='method'><a href="LayerSwitcher.html#setVisible">setVisible</a></li></ul></li><li><a href="MapManager.html">MapManager</a><ul class='methods'><li data-type='method'><a href="MapManager.html#addBaseLayer">addBaseLayer</a></li><li data-type='method'><a href="MapManager.html#addOverlayLayer">addOverlayLayer</a></li><li data-type='method'><a href="MapManager.html#featurePopup">featurePopup</a></li><li data-type='method'><a href="MapManager.html#getLayerById">getLayerById</a></li><li data-type='method'><a href="MapManager.html#render">render</a></li></ul></li><li><a href="OSMLayer.html">OSMLayer</a></li><li><a href="OverlayLayer.html">OverlayLayer</a></li><li><a href="WFSLayer.html">WFSLayer</a><ul class='methods'><li data-type='method'><a href="WFSLayer.html#refresh">refresh</a></li></ul></li><li><a href="Widget.html">Widget</a><ul class='methods'><li data-type='method'><a href="Widget.html#format">format</a></li><li data-type='method'><a href="Widget.html#refresh">refresh</a></li><li data-type='method'><a href="Widget.html#render">render</a></li></ul></li><li><a href="WidgetManager.html">WidgetManager</a><ul class='methods'><li data-type='method'><a href="WidgetManager.html#addWidget">addWidget</a></li><li data-type='method'><a href="WidgetManager.html#refresh">refresh</a></li><li data-type='method'><a href="WidgetManager.html#render">render</a></li></ul></li><li><a href="WMSLayer.html">WMSLayer</a><ul class='methods'><li data-type='method'><a href="WMSLayer.html#refresh">refresh</a></li></ul></li><li><a href="WPSWidget.html">WPSWidget</a><ul class='methods'><li data-type='method'><a href="WPSWidget.html#format">format</a></li><li data-type='method'><a href="WPSWidget.html#refresh">refresh</a></li><li data-type='method'><a href="WPSWidget.html#render">render</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">map/map-manager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import EventEmitter from 'events';
import ol from 'openlayers';

import LayerSwitcher from './layer-switcher';

import popupTemplate from '../../templates/map/feature-popup.hbs';

/**
 * This class takes care of everything related with the Map.
 */
class MapManager extends EventEmitter {
  /**
   * @param {Object} config - Configuration object
   * @param {Number[]} config.center - The initial center for the map
   * @param {Number} config.zoom - The initial zoom level
   */
  constructor(config) {
    super();

    this.center = config.center || [0, 0];
    this.zoom = config.zoom || 10;
    this.baseLayers = [];
    this.overlayLayers = [];

    this.createMap();
    this.createOverlay();
    this.addLayerSwitcher();
  }

  /**
   * Dashboard filter string wrapper
   * @member {String}
   * @readonly
   */
  get filterString() {
    return this.dashboard.filterString;
  }

  /**
   * Dashboard filters array wrapper
   * @member {String}
   * @readonly
   */
  get filters() {
    return this.dashboard.filters;
  }

  /**
   * Creates the [OpenLayers Map](https://openlayers.org/en/latest/apidoc/ol.Map.html) and sets its initial status.
   * @private
   */
  createMap() {
    this.view = new ol.View({
      center: ol.proj.fromLonLat(this.center),
      zoom: this.zoom,
    });

    this.map = new ol.Map({
      view: this.view,
      loadTilesWhileInteracting: true,
      interactions: ol.interaction.defaults({ mouseWheelZoom: false }),
      layers: this.layers,
    });

    this.viewProjection = this.view.getProjection();
    this.viewResolution = this.view.getResolution();

    this.map.on('moveend', (event) => {
      event.extent = this.map.getView().calculateExtent(this.map.getSize());
      this.emit('mapchange', event);
    });
  }

  /**
   * Creates the [OpenLayers Overlay](https://openlayers.org/en/latest/apidoc/ol.Overlay.html) to show popups.
   * @private
   */
  createOverlay() {
    this.overlay = new ol.Overlay({});
    this.map.addOverlay(this.overlay);
    this.map.on('singleclick', this.featurePopup.bind(this));
  }

  /**
   * Adds the LayerSwitcher control to the map
   * @private
   */
  addLayerSwitcher() {
    this.layerSwitcher = new LayerSwitcher();
    this.layerSwitcher.manager = this;
    this.map.addControl(this.layerSwitcher);
  }

  /**
   * Renders the map and all its components into the specefied container.
   * @param {HTMLElement} container - The element where the map will be rendered
   */
  render(container) {
    this.map.setTarget(container);
    setTimeout(() => this.map.updateSize(), 100);
  }

  /**
   * Adds a BaseLayer to the map.
   * @param {BaseLayer} layer - The layer to add
   */
  addBaseLayer(layer) {
    layer.manager = this;
    this.baseLayers.push(layer);
    this.map.addLayer(layer.layer);
  }

  /**
   * Adds an OverlayLayer to the map.
   * @param {OverlayLayer} layer - The layer to add
   */
  addOverlayLayer(layer) {
    layer.manager = this;
    this.overlayLayers.push(layer);
    this.map.addLayer(layer.layer);
    layer.refresh();
  }

  /**
   * Popup handler.
   * @param {Event} event - The event object triggered by user interaction
   */
  featurePopup(event) {
    const pixel = this.map.getEventPixel(event.originalEvent);
    const result = this.map.forEachFeatureAtPixel(pixel, (feature, layer) => ({
      feature,
      layer,
    }));
    if (result &amp;&amp; result.feature) {
      const properties = result.layer.popup.map(property => ({
        title: property.title,
        value: property.format ? property.format(result.feature.get(property.property)) :
        result.feature.get(property.property),
      }));
      const element = document.createElement('div');
      element.innerHTML = popupTemplate({
        properties,
      });
      this.map.beforeRender(ol.animation.pan({
        duration: 1000,
        source: this.view.getCenter(),
      }));
      pixel[0] += element.offsetWidth + 100;
      pixel[1] -= element.offsetHeight - 150;
      this.view.setCenter(this.map.getCoordinateFromPixel(pixel));
      this.overlay.setElement(element);
      this.overlay.setPosition(event.coordinate);
    } else {
      this.overlay.setElement(null);
    }
  }

  /**
   * Searches and returns a specifc layer
   * @param {String} id - The layer ID to find
   * @returns {Layer}
   */
  getLayerById(id) {
    let layer = this.baseLayers.find(l => l.id === id);
    if (!layer) {
      layer = this.overlayLayers.find(l => l.id === id);
    }
    return layer;
  }
}

export default MapManager;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu Nov 24 2016 20:28:09 GMT-0300 (ART) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
